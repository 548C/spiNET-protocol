# spiNET 协议 v0.1
作者：548C
## 简述
本协议致力于基于现有的SPI（Serial Peripheral Interface，串行外设接口）协议及其相应的硬件及底层API设计设计出一种抽象层级更高的类网络的通过设备号（类似于IP地址）加端口号的不同嵌入式硬件模块中例程到例程的一主多从通信协议。
## 数据传输模式
该协议包含以下三种数据传输模式：
1. 空闲模式：8位为1字，一帧包含1字的低速率线路保持通信，当其数据为零时中断当前通信，当其数据为 SPINET_MODEC_STANDBY 宏定义的值时，仅保持通路的连接，不传输有效数据；当其数据为 SPINET_MODEC_T_TEXT 宏定义的值时，切换为正文模式；当其数据为 SPINET_MODEC_T_DATE 宏定义的值时，切换为数据模式。
2. 正文模式：16位为1字，一帧包含两字的高速率正文通信，主要为控制行为的指令，且由接收和发送端口号和操作码组成（关于设备号和端口号的详细信息见下文“正文报头与端到端传输”部分）。
3. 数据模式：16位为1字，一帧包含多字的高速率数据传输，通过前文的正文通信控制其字数（且大小不应超过 SPIFRAME_MAX_WORD_COUNT 宏定义的值）、目标位置和结束后转入的模式。
对于工作在全/半双工模式下的设备，双向线路应可分别设置其通信模式。除了数据模式，其余两种模式均需显式地进行模式转换操作。对于每一种数据帧的每次传输，都应该使用校验码（如CRC）保证其传输正确性并在出现错误时进行重传，在此基础上，协议不要求每次通信都有响应信号。
## 服务器行为
服务器应作为一个SPI网络中唯一的主机对时钟线严格地进行控制，即从机绝对不应该操作时钟线。同时，服务器对所有的SPI片选线，应尽量配置为非硬件SPI CS的可配置中断的GPIO线，以通过中断处理将原SPI的片选的电平敏感修改为边缘触发，再以此为基础实现客户端从机通过改变片选线电平触发服务器的（软）中断通知服务器自己的通信请求。服务器可根据实际情况设计如何仲裁地响应这些请求。
## 客户端行为
客户端应作为一个SPI网络中的一个从机在服务器发送片选信号（电平边缘，见上文“服务器行为”）时准备好硬件和数据，并在被选中期间绝不允许操作片选线。若客户端在未被选中时产生了通信需求，应（原子的）产生一个对应的电平边缘尝试握手。
## 正文报头与端到端传输
对于一次传输32位的正文信息，其前16位中的前8位为接收端口号，后8位为发送端口号，由服务器和客户端解析、处理和转发。最后转发给目标端口时，前8位被舍弃并更改为发送方设备号。同时，接收端口号至少应保留“传输控制”、“本地回环”等特殊端口号。
## 传输控制
当数据接收端接收到接收端口号为保留的“传输控制”特殊端口号时，接下来不会把这一帧正文发送给任何端口，而是自行解析其内容并做出动作。常见的“传输控制”包括数据传输模式的切换、传输的关闭或中止、跨设备端口号的注册（主要为客户端发往服务器）等。
## 注意
以下规格不由本协议规定，取决于不同实现所采取的约定！
- 默认的字节序及可能的转换方法
- 速率窗口及可能的调速方法
- 握手边缘极性的选择
- CRC校验的实现方法及选用的多项式
- 数据校验具体使用的方法
- 及其他的一些程序设计细节......
